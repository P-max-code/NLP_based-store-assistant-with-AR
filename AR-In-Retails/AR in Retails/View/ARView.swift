//
//  ARView.swift
//  AR in Retails
//
//  Created by Ashis Laha on 4/7/18.
//  Copyright Â© 2018 Ashis Laha. All rights reserved.
//

import UIKit
import ARKit

protocol ARViewDelegate: class {
    func getGroundClearance(_ groundClearance: Float)
}

class ARView: ARSCNView {
    
    var showFeaturePoints = true
    public var orientToTrueNorth = true
    public var groundClearance: Float = 0.0
    weak var viewDelegate: ARViewDelegate?
    
    //MARK: Setup
    public convenience init() {
        self.init(frame: CGRect.zero, options: nil)
    }
    
    public override init(frame: CGRect, options: [String : Any]? = nil) {
        super.init(frame: frame, options: options)
    }
    
    required public init?(coder aDecoder: NSCoder) {
        super.init(coder: aDecoder)
    }
    
    override public func layoutSubviews() {
        super.layoutSubviews()
    }
    
    public func run() {
        // Create a session configuration
        let configuration = ARWorldTrackingConfiguration()
        configuration.planeDetection = .horizontal
        configuration.worldAlignment =  orientToTrueNorth ? .gravityAndHeading : .gravity
        
        // Run the view's session
        session.run(configuration)
        delegate = self
        showsStatistics = false
        debugOptions = [ARSCNDebugOptions.showFeaturePoints]
    }
    
    public func pause() {
        session.pause()
    }
}

extension ARView: ARSCNViewDelegate {
    func renderer(_ renderer: SCNSceneRenderer, didAdd node: SCNNode, for anchor: ARAnchor) {
        guard let planeAnchor = anchor as? ARPlaneAnchor else { return }
        
        groundClearance = planeAnchor.center.y
        viewDelegate?.getGroundClearance(groundClearance)
        print("groundClearance: ",groundClearance)
        
        let width = CGFloat(planeAnchor.extent.x)
        let height = CGFloat(planeAnchor.extent.z)
        let plane = SCNPlane(width: width, height: height)
        
        // 3
        plane.materials.first?.diffuse.contents = UIColor.blue
        
        // 4
        let planeNode = SCNNode(geometry: plane)
        
        // 5
        let x = CGFloat(planeAnchor.center.x)
        let y = CGFloat(planeAnchor.center.y)
        let z = CGFloat(planeAnchor.center.z)
        planeNode.position = SCNVector3(x,y,z)
        planeNode.eulerAngles.x = -.pi / 2
        
        // 6
        //scene.rootNode.addChildNode(planeNode)
    }
    
    public func sessionWasInterrupted(_ session: ARSession) {
        print("session was interrupted")
    }
    
    public func sessionInterruptionEnded(_ session: ARSession) {
        print("session interruption ended")
    }
    
    public func session(_ session: ARSession, didFailWithError error: Error) {
        print("session did fail with error: \(error)")
    }
    
    public func session(_ session: ARSession, cameraDidChangeTrackingState camera: ARCamera) {
        switch camera.trackingState {
        case .limited(.insufficientFeatures):
            print("camera did change tracking state: limited, insufficient features")
        case .limited(.excessiveMotion):
            print("camera did change tracking state: limited, excessive motion")
        case .limited(.initializing):
            print("camera did change tracking state: limited, initializing")
        case .normal:
            print("camera did change tracking state: normal")
        case .notAvailable:
            print("camera did change tracking state: not available")
        default: break
        }
    }
}
